#!/bin/sh
# This script is the first process (PID 1) inside the initrd.
# It determines whether to run the automated installer or drop to a debug shell.

echo "==> initrd init script started"

# Mount essential filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
mount -t efivarfs none /sys/firmware/efi/efivars 2>/dev/null || true

echo "==> Creating /run directory for udev"
mkdir -p /run

echo "==> Decompressing kernel modules..."
find /lib/modules -name "*.ko.xz" -exec xz -d {} \;

echo "==> Running depmod -a"
busybox depmod -a
busybox modprobe vfat || true

echo "==> Starting udev"
/bin/udevd --daemon
udevadm trigger --action=add --type=subsystems
udevadm trigger --action=add --type=devices
udevadm settle

busybox modprobe nls_iso8859-1 || true


# Default to install mode if not specified
mode="install"

# Read the kernel command line and look for our custom arguments
for arg in $(cat /proc/cmdline); do
    case $arg in
        initrd.mode=*)
            mode=${arg#*=}
            ;;
    esac
done

echo "==> Boot mode: $mode"

# Export cloud_init_url for the installer to use
export PS1='initrd# '
export TERM=xterm
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

case $mode in
    shell)
        echo "==> Dropping to debug shell"
        # Execute a shell. If you exit this shell, the kernel will panic.
        exec /bin/sh
        ;;
    install|*)
        echo "==> Starting automated installer"
        /bin/os-installer
        INSTALLER_EXIT_CODE=$?

        if [ "$INSTALLER_EXIT_CODE" -eq 0 ]; then
            echo "==> Go OS Installer finished successfully!"
        else
            echo "==> Go OS Installer failed with exit code $INSTALLER_EXIT_CODE!"
        fi
        
        echo "==> Dropping to debug shell..."
        # Make the 'reboot' command work reliably in the debug shell
        alias reboot='sync && echo b > /proc/sysrq-trigger'
        exec /bin/sh
        ;;
esac