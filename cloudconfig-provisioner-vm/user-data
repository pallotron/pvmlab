## template: jinja
#cloud-config
ssh_pwauth: true
users:
  - name: ubuntu
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      {{ ds.meta_data.public_keys | join('\n') }}

chpasswd:
  users:
    - {name: ubuntu, password: pass, type: text}
    - {name: root, password: pass, type: text}
  expire: False

runcmd:
  - 'echo "iptables-persistent iptables-persistent/autosave_v4 boolean true" | debconf-set-selections'
  - 'echo "iptables-persistent iptables-persistent/autosave_v6 boolean true" | debconf-set-selections'
  - 'apt-get update'
  - 'DEBIAN_FRONTEND=noninteractive apt-get -y install acpid iptables-persistent'
  - 'sed -i "/net.ipv4.ip_forward/d" /etc/sysctl.conf'
  - 'echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf'
  - 'sysctl -p'
  - 'iptables -t nat -A POSTROUTING -o enp0s1 -j MASQUERADE'
  - 'iptables-save > /etc/iptables/rules.v4'
